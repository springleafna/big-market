# 大营销

1. 首先将抽奖的策略初始化  
创建一个Map集合，key为抽奖生成的随机数，value为奖品Id  
每种奖品都有对应的概率（和为1？暂时为1）  
假设概率分布为：  
奖品1：0.3  
奖品2：0.2   
奖品3：0.2  
奖品4：0.1  
奖品5：0.1  
奖品6：0.05  
奖品7：0.04  
奖品8：0.0099  
奖品9：0.0001   
将概率总和除以最小的奖品概率，得到每个奖品的权重：  
1/0.0001=10000  
那么这个Map集合的大小为10000，key为0-9999，value为奖品Id  
则这10000个key中有一个位置存放的是概率为0.0001的奖品Id，有99个位置存放的是概率为0.0099的奖品Id，以此类推  
这样随机生成一个0-9999的随机数，然后根据这个随机数在Map集合中查找奖品Id，即可得到奖品  

2. rule_weight规则的策略  
根据策略Id获取到该策略实体，然后判断该策略的rule_model中是否有rule_weight规则，  
如果无则结束   
如果有，则在strategy_rule表中查找对应rule_weight规则   
比如该策略的rule_model为：4000:102,103,104,105 5000:102,103,104,105,106,107 6000:102,103,104,105,106,107,108,109
消耗4000分，必中奖范围......  
然后将这个规则转换为Map集合：Map<Integer, List<Integer>>，key为积分达标要求，value为奖品Id列表  
然后在第一步中的Map集合中去除其他没达到中奖范围的奖品Id，得到最终的奖品IdMap集合  
这样随机生成一个在该Map范围内的随机数，然后根据这个随机数在Map集合中根据key去取value即对应的奖品Id  

### 抽奖策略：

#### rule_weight规则：

rule_weight规则是指在抽奖策略中，根据用户的积分情况，给予不同的奖品权重，以达到不同奖品的概率更高的目的.  
比如：4000:102,103,104,105 5000:102,103,104,105,106,107 6000:102,103,104,105,106,107,108,109  
表示用户积分4000分以上，抽到的奖品范围为102、103、104、105   
用户积分5000分以上，奖品在102、103、104、105、106、107之中   
用户积分6000分以上，奖品在102、103、104、105、106、107、108、109之中。  

#### rule_blacklist规则：

黑名单规则，是指在抽奖策略中，将一些不合适的用户加入黑名单，从而在这些黑名单用户抽奖时返回的奖品固定为比如1积分。   

#### rule_lock规则：

积分锁规则，是指某些奖品只有达到一定的抽奖次数后才解锁。

### 抽奖规则过滤：

#### 工厂模式+策略模式+Map+自定义注解+枚举：

在抽奖时需要进行判断，该用户是否是黑名单用户，该抽奖是否有权重规则，以及抽奖后用户积分是否达标，库存是否充分等等。。。
1. 首先创建了一个ILogicFilter接口，该接口有一个方法Filter：接受一个规则物料实体对象，返回一个规则动作实体
2. 其下有三个实现类都重写了Filter方法：
 - RuleBlackListLogicFilter：黑名单过滤器，判断用户是否在黑名单中，如果在黑名单中则返回固定奖品
 - RuleWeightLogicFilter：权重过滤器，判断抽奖是否有权重规则，如果有则进行规则内的奖品抽取
 - RuleLockLogicFilter：积分过滤器，判断用户是否达标
3. 有一个自定义注解LogicStrategy，其中包含着一个枚举，表示各个过滤器的类型，该注解可以标注在所有具体的过滤器上
4. 还有一个规则工厂DefaultLogicFactory 其中的Map<String, ILogicFilter<?>> logicFilterMap用来存放所有被LogicStrategy注解的过滤器


### 抽奖基本流程：
1. 首先装配策略
2. 然后执行责任链（责任链中先判断用户是否是黑名单用户，如果是则直接返回固定奖品，如果不是则判断是否有权重规则，如果有则进行规则内的奖品抽取，如果没有则判断用户是否达标，如果达标则进行抽奖，如果不达标则返回固定奖品）